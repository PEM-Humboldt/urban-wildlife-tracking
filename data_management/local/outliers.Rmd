---
title: "In depth analysis of errors in the movement data and deletion of outliers"
author: "Marius Bottin"
date: "`r Sys.Date()`"
output: 
    github_document:
      toc: true
      toc_depth: 4
      dev: 'jpeg'
always_allow_html: true
---


```{r setup, echo=F,message=F,warning=FALSE,results='hide'}
stopifnot(
require(RPostgreSQL)
&
require(rpostgis)
&
require(sp)
&
require(geodata)
&
require(DBI)
&
require(ctmm)
&
require(rgeos)
)

knitr::opts_chunk$set(cache=T,tidy.opts = list(width.cutoff = 70), tidy = TRUE, fig.path="Fig/extraDB_",echo=T)
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  paste0("\n \\", "footnotesize","\n\n", x, "\n\n \\normalsize\n\n")
})
options(knitr.kable.NA = "---")
dirData <- "../../../uwt_repo_data/extra_spatial/"
set.seed(9835)
extraSp<-dbConnect(drv = PostgreSQL(), dbname="move_extra_sp")
# For avoiding setting the connection name in the SQL chunks:
knitr::opts_chunk$set(connection=extraSp)
```

# Getting the general data from movebank

Here we will apply the script to get all the data from movebank. 
If needed, more details are presented in the document [importingCleaningFormatting.Rmd](./importingCleaningFormatting.md)

```{r}
source("importingMovebankData.R")
source("movebankFromDirectApi.R")
source("itis_taxo.R")
```


# Analyses of errors

In the document [importingCleaningFormatting.Rmd](./importingCleaningFormatting.md), you may see how to use the function from `ctmm` and `move` for managing movement data.
However, there are some decisions to take, animal by animal, in order to delete erroneous data from the individual datasets.

The criteria for pointing outliers may be extracted from:

* HDOP data associated with each relocation
* distance from the previous and the following point
* average speed calculated on every trajectory between 2 relocation points
* it is important to take into account the fact that some of the relocation might be missing and therefore the comparation of distances and speeds may be irrelevant
* `ctmm` uses  calibration datasets in its own criteria to search for outliers
* `ctmm` also allows to create semi-variogram that apparently may be of use for searching for outliers

With all these criteria, it is possible to point out which are the points which may be erroneous.
However, it seems that there are no real procedure to automatically suppress outliers based on them.
Each outlier should be evaluated visually, because it might be a real change in the movement behavior of the animals.

## Organizing data

In order to be able to apply criteria in a homogenized way, I find it easier to download directly the data from each animal separately:


```{r, warning=F, message=F}
aniNames <- animals$local_identifier[animals$number_of_events>20]
# The calibration files do not have exactly the same names as the animals
caliNames <- gsub("\\.csv","",dir("../../../uwt_repo_data/calibration/"))

tabNames <- data.frame(
  aniNames=aniNames,
  partLetter=gsub("GarzaAve","Garza",gsub("-","",gsub("^([-A-Za-z]+)([0-9]+)$","\\1",aniNames))),
  partNumber=as.integer(gsub("^([-A-Za-z]+)([0-9]+)$","\\2",aniNames)),
  calibName=NA
)
matches <- sapply(caliNames,function(x,tab)
  {
    let <- gsub("^([A-Za-z]+)([0-9]+$)","\\1",x)
    num <- gsub("^([A-Za-z]+)([0-9]+$)","\\2",x)
    which(tab$partLetter==let&tab$partNumber==num)
  }, tab=tabNames)
tabNames$calibName[matches]<-caliNames
# No sé porque pero el archivo de calibración de Guacharaca01, Guacharaca02, Pigua2, Garza1, GarzaAve4 contiene error: no se hará la calibración!
tabNames$calibName[tabNames$aniNames%in%c("Guacharaca01","Guacharaca03","Pigua2","Garza1","GarzaAve4")]<-NA

rawList <- list()
for(i in 1:nrow(tabNames))
{
  rawList[[tabNames$aniNames[i]]]<-list()
  rawList[[i]]$moveData=getMovebankData(study = study_id, login = lgin,animalName = tabNames$aniNames[i])
  rawList[[i]]$ctmmData=as.telemetry(rawList[[i]]$moveData)
  if(!is.na(tabNames$calibName[i]))
  {
    rawList[[i]]$calibData<-as.telemetry(paste("../../../uwt_repo_data/calibration/",tabNames$calibName[i],".csv",sep=""))
  }
}
save(rawList,file="rawData.RData")
```

## Calibration with `ctmm`

Which individuals have calibration data:

```{r}
(hasCalibData <- sapply(rawList,function(x)"calibData"%in%names(x)))
```

Let's add the calibration model to the list, when the animal have a calibration dataset, and apply this model to the real `telemetry` object from `ctmm`:

```{r}
for (i in 1:length(rawList))
{
  if(hasCalibData[i])
  {
    rawList[[i]]$UERE_calib<-uere.fit(rawList[[i]]$calibData)
    uere(rawList[[i]]$ctmmData)<-rawList[[i]]$ctmmData
  }
}
```


## Differences between UERE errors and hdop

```{r}
plot(rawList[[1]]$ctmmData[1:10,],error=2, main="UERE error plot from ctmm")
plot(rawList[[1]]$moveData[1:10],cex=rawList[[8]]$moveData$gps_hdop*2, main = "Raw HDOP plot")


plot(rawList$Zorro02$moveData$gps_hdop,outlie(data = rawList$Zorro02$ctmmData)$VAR.distance)
```

As you can see the two graphs are pretty similar.
It is due to the fact that in our case, the data on which the UERE model is calculated is mostly extracted from HDOP, calibrated from the calibration dataset.

While this calibration is important to create a good movement model with `ctmm`, finding outliers through the HDOP should be relevant.




